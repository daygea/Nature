<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nature Speaks</title>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css">
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <div class="container-fluid">
        <h1 style="text-align: center;">Nature Speaks</h1>

        <div class="row">
            <div id="configurationResult" class="col-sm-3 odusign">
            </div>
            <div class="col-sm-6">
                <h3 style="text-align: center;">Enter Your Divination Details</h3>
                <label for="mainCast">Odu Ifa</label>
                <select id="mainCast" class="form-control"></select>
                <br>

                <label for="orientation">Orientation (Ire / Ayewo)</label>
                <select id="orientation" onchange="updateSpecificOrientation()" class="form-control">
                    <option value="Positive">Ire</option>
                    <option value="Negative">Ayewo</option>
                </select>
                <br>

                <label for="specificOrientation">Specific Orientation</label>
                <select id="specificOrientation" class="form-control"></select>
                <br>

                <label for="solution">Solution (Ebo / Adimu)</label>
                <select id="solution" onchange="updateSolutionDetails()" class="form-control">
                    <option value="Ebo" selected>Ebo</option>
                    <option value="Adimu">Adimu</option>
                </select>
                <br>

                <label for="solutionDetails">Solution Details</label>
                <select id="solutionDetails" class="form-control"></select>
                <br>

                <button onclick="performUserDivination()" class="btn btn-md btn-danger">Reveal Message</button>

                <div id="divinationResult">
                    <!-- Result will be displayed here -->
                </div>
            </div>
            <div class="col-sm-3 numerology">
                <p><b>Enter your birth date.</b></p>
                    <div id="birthdate-box">
                        <input type="date" id="birthdate" /><br/><br/>
                        <button class="btn btn-md btn-primary" id="determine-btn">Get Meaning</button>
                    </div>

                    <div id="result"></div>
            </div>
        </div>
        <script type="text/javascript" src="js/oduMessages.js"></script>
        <script type="text/javascript" src="js/numerology.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
        <script src="https://js.paystack.co/v1/inline.js"></script>
    <script>

    const PAYSTACK_PUBLIC_KEY = "pk_test_your_key_here";
       // Define free Odùs (first 16)
    const freeOdus = [
        "Ejiogbe", "Oyeku Meji", "Iwori Meji", "Idi Meji", "Irosun Meji", "Owonrin Meji", 
        "Obara Meji", "Okanran Meji", "Ogunda Meji", "Osa Meji", "Ika Meji", "Oturupon Meji", 
        "Otura Meji", "Irete Meji", "Ose Meji", "Ofun Meji", "Osa Owonrin"
    ];
    

    const SECRET_KEY = "your_random_secret";

        // Encrypt data using AES
    function encryptData(data) {
        return CryptoJS.AES.encrypt(JSON.stringify(data), SECRET_KEY).toString();
    }

    // Decrypt data
    function decryptData(encryptedData) {
        try {
            const bytes = CryptoJS.AES.decrypt(encryptedData, SECRET_KEY);
            return JSON.parse(bytes.toString(CryptoJS.enc.Utf8));
        } catch (e) {
            return null;
        }
    }


    // Check if an Odù is paid for and not expired
    function isOduPaid(oduName) {
        const storedData = localStorage.getItem("paidOdus");
        if (!storedData) return false;

        const paidOdus = decryptData(storedData);
        if (!paidOdus || !paidOdus[oduName]) return false;

        const expirationTime = paidOdus[oduName];
        return Date.now() < expirationTime; // True if still valid
    }

    // Save paid Odù access
    function grantOduAccess(oduName) {
        let paidOdus = decryptData(localStorage.getItem("paidOdus")) || {};
        paidOdus[oduName] = Date.now() + 24 * 60 * 60 * 1000; // Set 24-hour expiry
        localStorage.setItem("paidOdus", encryptData(paidOdus));
    }

    // Process Payment with Paystack
    function payForOdu(oduName) {
        let handler = PaystackPop.setup({
            key: PAYSTACK_PUBLIC_KEY,
            email: "user@example.com", // Replace dynamically if possible
            amount: 100000, // ₦1000 (amount is in kobo)
            currency: "NGN",
            callback: function(response) {
                alert("Payment successful! Ref: " + response.reference);
                grantOduAccess(oduName);
                // displayOduMessage(oduName);
                performUserDivination();
            },
            onClose: function() {
                alert("Payment cancelled.");
            }
        });
        handler.openIframe();
    }

        // Base Odùs
        const baseOdus = {
            "Ejiogbe": ["|", "|", "|", "|"],
            "Oyeku Meji": ["||", "||", "||", "||"],
            "Iwori Meji": ["||", "|", "|", "||"],
            "Idi Meji": ["|", "||", "||", "|"],
            "Irosun Meji": ["|", "|", "||", "||"],
            "Owonrin Meji": ["||", "||", "|", "|"],
            "Obara Meji": ["|", "||", "||", "||"],
            "Okanran Meji": ["||", "||", "||", "|"],
            "Ogunda Meji": ["|", "|", "|", "||"],
            "Osa Meji": ["||", "|", "|", "|"],
            "Ika Meji": ["||", "|", "||", "||"],
            "Oturupon Meji": ["||", "||", "|", "||"],
            "Otura Meji": ["|", "||", "|", "|"],
            "Irete Meji": ["|", "|", "||", "|"],
            "Ose Meji": ["|", "||", "|", "||"],
            "Ofun Meji": ["||", "|", "||", "|"]
        };

        // Generate all 256 Odù combinations
        const generateOduCombinations = () => {
            const baseOduNames = Object.keys(baseOdus);
            const allOdus = [...baseOduNames];
            baseOduNames.forEach(firstOdu => {
                baseOduNames.forEach(secondOdu => {
                    if (firstOdu !== secondOdu) {
                        let firstName = firstOdu === "Ejiogbe" ? "Ogbe" : firstOdu.split(" ")[0];
                        let secondName = secondOdu === "Ejiogbe" ? "Ogbe" : secondOdu.split(" ")[0];
                        allOdus.push(`${firstName} ${secondName}`);
                    }
                });
            });
            return allOdus;
        };

        const allOdus = generateOduCombinations();

        // Populate dropdowns
        const populateDropdown = (dropdown, options) => {
            dropdown.innerHTML = ""; // Clear existing options
            options.forEach(option => {
                const optElement = document.createElement("option");
                optElement.value = option;
                optElement.textContent = option;
                dropdown.appendChild(optElement);
            });
        };

        const populateDropdowns = () => {
            const mainCastDropdown = document.getElementById("mainCast");
            populateDropdown(mainCastDropdown, allOdus);
            updateSpecificOrientation();
            updateSolutionDetails(); // Populate solution details on page load
        };

        // Check if oduMessages has data for the selected mainCast, fallback if not

        const getOduMessageData = (mainCast, orientation, specificOrientation, solution, specificSolution) => {
           
            const orientationData = oduMessages[mainCast]?.[orientation];
            const specificOrientationData = orientationData?.[specificOrientation];
            const solutionData = specificOrientationData?.[solution]?.[specificSolution];
            const messageData = orientationData?.[specificOrientation].Message;
            return {
                message: messageData || "No message available &",
                solutionInfo: solutionData || "no message available for the selected combination.",
                orientationMessage: orientationData?.Messages || "No general message available for this orientation.",
                specificOrientationMessage: specificOrientationData?.Message || "No message available for this specific orientation."
            };
        };

        const updateSpecificOrientation = () => {
                const orientation = document.getElementById("orientation").value;
                const specificOrientationDropdown = document.getElementById("specificOrientation");
                const mainCast = document.getElementById("mainCast").value;

                // Use fallback options if no data exists in `oduMessages`
                const defaultOptions =
                    orientation === "Positive"
                        ? ["Aiku", "Aje", "Isegun", "Igbale Ese", "Gbogbo Ire"]
                        : ["Iku", "Arun", "Ejo", "Ofo", "Okutagbunilese"];
                const options =
                    oduMessages[mainCast]?.[orientation] 
                        ? Object.keys(oduMessages[mainCast][orientation])
                        : defaultOptions;

                populateDropdown(specificOrientationDropdown, options);
            };

             const updateSolutionDetails = () => {
                const solution = document.getElementById("solution").value;
                const solutionDetailsDropdown = document.getElementById("solutionDetails");
                const mainCast = document.getElementById("mainCast").value;

                // Use fallback options if no data exists in `oduMessages`
                const defaultSolutionDetails =
                    solution === "Ebo"
                        ? ["Akoru", "Esha"]
                        : ["Ori", "Osha", "Eegun", "Ifa"];
                const details =
                    oduMessages[mainCast]?.Solution?.[solution] 
                        ? oduMessages[mainCast].Solution[solution]
                        : defaultSolutionDetails;

                populateDropdown(solutionDetailsDropdown, details);
            };



    const performUserDivination = () => {
    const mainCast = document.getElementById("mainCast").value;
    // handleOduAccess(mainCast);
    const orientation = document.getElementById("orientation").value;
    const specificOrientation = document.getElementById("specificOrientation").value;
    const solution = document.getElementById("solution").value;
    const solutionDetails = document.getElementById("solutionDetails").value;

    const { message, solutionInfo } = getOduMessageData(mainCast, orientation, specificOrientation, solution, solutionDetails);

    const orisha = oduMessages[mainCast]?.Orisha || "No orisha data available.";
    const taboo = oduMessages[mainCast]?.Taboo || "No taboo available.";
    const names = oduMessages[mainCast]?.Names || "No names available.";
    const occupation = oduMessages[mainCast]?.Occupation || "No occupation available.";
    const credit = oduMessages[mainCast]?.Credit || "No credit available.";
    const alias = oduMessages[mainCast]?.alias || "No alias available.";
    const audioUrls = oduMessages[mainCast]?.audioURL || [];
    const videoUrls = oduMessages[mainCast]?.videoURL || [];

    //Map orientation to descriptive text
        const orientationText = orientation === "Positive" ? "Ire" : "Ayewo";
        const orientationEmi = orientation === "Positive" ? "Awonranmaja" : "Ajagunmale";

    const audioHTML = audioUrls.length
        ? audioUrls.map(url => `<p><a href="${url}" target="_blank">Listen to Audio</a></p>`).join("")
        : "<p>No audio available.</p>";

    const videoHTML = videoUrls.length
        ? videoUrls.map(url => `<p><a href="${url}" target="_blank">Watch Video</a></p>`).join("")
        : "<p>No video available.</p>";

    const resultElement = document.getElementById("divinationResult");

    if (freeOdus.includes(mainCast) || isOduPaid(mainCast)) {
    resultElement.innerHTML = `
        <h1 style="text-align: center;">Divination Result</h1>
        <h3 style="text-align: center;">${mainCast}, ${orientationText} (${specificOrientation}), ${solution} ${solutionDetails}</h3>
        <p>${message} ${solutionInfo}</p>
        <p><strong>Orisha:</strong> ${orisha}</p>
        <p><strong>Alias:</strong> ${alias}</p>
        <p><strong>Taboo:</strong> ${taboo}</p>
        <p><strong>Names:</strong> ${names}</p>
        <p><strong>Occupation:</strong> ${occupation}</p>
        ${audioHTML}
        ${videoHTML}
        <p style="padding-bottom:50px"><strong>Credit:</strong> ${credit}</p>
    `;
     } else {
         document.getElementById("divinationResult").innerHTML = `
               <center> <p style="padding-top:30px;">This Odù requires payment to access. Click below to proceed.</p>
                <button class="btn btn-lg" onclick="payForOdu('${mainCast}')">Pay ₦1000 for 24-hour access</button></center>
            `;
        }
    displayConfiguration(mainCast);
};

    const displayConfiguration = (oduName) => {
            const configurationElement = document.getElementById("configurationResult");
            let configHTML = "";

            if (baseOdus[oduName]) {
                // For the first 16 Odùs
                const config = baseOdus[oduName];
                configHTML = `<h1><b>Odu Ifa</b></h1>`;
                config.forEach(line => {
                    configHTML += `<p>&nbsp;&nbsp;${line} &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ${line}</p>`;
                });
            } else {
                // For combinations like "Ogbe Oyeku"
                const parts = oduName.split(" ");
                const firstPart = parts[0] === "Ogbe" ? "Ejiogbe" : `${parts[0]} Meji`;
                const secondPart = parts[1] === "Ogbe" ? "Ejiogbe" : `${parts[1]} Meji`;

                const firstConfig = baseOdus[firstPart];
                const secondConfig = baseOdus[secondPart];

                if (firstConfig && secondConfig) {
                    configHTML = `<h1><b>Odu Ifa</b></h1>`;
                    firstConfig.forEach((line, index) => {
                        configHTML += `<p>&nbsp;&nbsp;${secondConfig[index]} &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ${line}</p>`;
                    });
                } else {
                    configHTML = `<h2>Odu</h2><p>Configuration not found for ${oduName}.</p>`;
                }
            }

            configurationElement.innerHTML = configHTML;

        };

        // Initialize on page load
        window.onload = populateDropdowns;

         // Function to calculate the single-digit numerology number
        function getNumerologyNumber(dateString) {
            let digits = dateString.replace(/[^0-9]/g, ""); // Remove non-numeric characters
            let sum = digits.split("").reduce((acc, num) => acc + parseInt(num), 0);
            
            // Reduce to a single-digit number
            while (sum > 9) {
                sum = sum.toString().split("").reduce((acc, num) => acc + parseInt(num), 0);
            }
            
            return sum;
        }

        // Handle button click to determine the meaning
        document.getElementById("determine-btn").onclick = () => {
            const birthdate = document.getElementById("birthdate").value;
            const resultDiv = document.getElementById("result");

            if (!birthdate) {
                resultDiv.style.display = "block inline";
                resultDiv.innerHTML = "<span style='color:red; font-size:14px'>Select your birth date.</span>";
                return;
            }

            // Get the single-digit numerology number
            const numerologyNumber = getNumerologyNumber(birthdate);
            resultDiv.style.display = "none";
            const resultElement = document.getElementById("divinationResult");
            resultElement.innerHTML = `
                <center><h1>Numerology No: ${numerologyNumber}</h1></center>
                <p>${numerologyMeanings[numerologyNumber]}</p>
            `;
        };

    </script>

    </div>
</body>
</html>
